CREATE OR REPLACE VIEW EJMSCOUNT AS
SELECT U.USER_ID,
       U.DEPT_FULLNAME || ' ' || U.USER_NAME USER_NAME,
       NVL(A.ACNT, 0) COLLPROC_COUNT,
       NVL(B.BCNT, 0) DELIVERY_COUNT,
       NVL(C.CCNT, 0) INPUTING_COUNT,
       NVL(D.DCNT, 0) RESEARCH_COUNT,
       NVL(E.ECNT, 0) SINCHUNG_COUNT,
       NVL(F.FCNT, 0) S_PROCWAIT_COUNT
FROM USR U,
     (SELECT U.USER_ID, COUNT(*) ACNT
      FROM DOCMST D, USR U
      WHERE D.CHRGUSRCD = U.USER_ID
      AND D.COLDEPTCD = U.DEPT_ID
      AND D.DOCSTATE = '04'
      GROUP BY U.USER_ID) A,
     (SELECT U.USER_ID, COUNT(*) BCNT
      FROM DOCMST D, TGTDEPT T, USR U
      WHERE D.SYSDOCNO = T.SYSDOCNO
      AND D.DOCSTATE = '04'
      AND T.SUBMITSTATE = '01'
      AND T.TGTDEPTCD = U.DEPT_ID
      AND (U.DELIVERY_YN = 'Y' OR U.MGRYN = 'Y')
      GROUP BY U.USER_ID) B,
     (SELECT U.USER_ID, COUNT(*) CCNT
      FROM DOCMST A, TGTDEPT B, INPUTUSR C, USR U,
           (SELECT SYSDOCNO, 2 GUBUN, INPUTUSRID FROM SANCTGT WHERE SANCYN = 0) S
      WHERE A.SYSDOCNO = B.SYSDOCNO
      AND A.SYSDOCNO = C.SYSDOCNO
      AND B.TGTDEPTCD = C.TGTDEPT
      AND A.DOCSTATE = '04'
      AND C.INPUTUSRID = U.USER_ID
      AND C.TGTDEPT = U.DEPT_ID
      AND B.SUBMITSTATE = '02'
      AND C.INPUTSTATE IN ('01', '02')
      AND C.SYSDOCNO = S.SYSDOCNO(+)
      AND C.INPUTUSRID = S.INPUTUSRID(+)
      AND NVL(S.GUBUN, 1) = 1
      GROUP BY U.USER_ID) C,
     (SELECT USER_ID, COUNT(*) DCNT
      FROM RCHMST T1, RCHDEPT T2, RCHOTHERTARGET T3, USR U
      WHERE T1.RCHNO = T2.RCHNO(+)
      AND T1.RCHNO = T3.RCHNO(+)
      AND T1.OPENTYPE = '1'
      AND T1.RANGE = '1'
      AND T3.TGTGBN(+) = '1'
      AND TO_CHAR(SYSDATE,'YYYY-MM-DD') BETWEEN T1.STRDT AND T1.ENDDT
      AND (CASE NVL(T2.TGTCODE, '0') WHEN '0' THEN 1 WHEN U.DEPT_ID THEN 1 ELSE 0 END = 1
           OR CASE NVL(T2.TGTCODE, '0') WHEN '0' THEN 1 WHEN U.USER_ID THEN 1 ELSE 0 END = 1)
      AND CASE NVL(T3.TGTCODE, '0') WHEN '0' THEN 1 
          WHEN (SELECT GRADE_ID FROM USR WHERE USER_ID = U.USER_ID) THEN 1 ELSE 0 END = 1
      AND CASE (SELECT COUNT(*) FROM CCD WHERE CCDCD = '016' AND CCDSUBCD = '02' AND UPPER(CCDNAME) = 'N')
          WHEN 1 THEN CASE (SELECT COUNT(DISTINCT RCHNO) FROM RCHANS WHERE CRTUSRID = U.USER_ID AND RCHNO = T1.RCHNO)
          WHEN 0 THEN 1 ELSE 0 END ELSE 1 END = 1
      --AND CASE T1.DUPLICHECK WHEN '0' THEN 0
      --    ELSE CASE (SELECT COUNT(DISTINCT RCHNO) FROM RCHANS WHERE CRTUSRID = U.USER_ID AND RCHNO = T1.RCHNO)
      --         WHEN 0 THEN 0 ELSE 1 END END = 0  
      GROUP BY USER_ID) D,
     (SELECT U.USER_ID, COUNT(*) ECNT
      FROM REQFORMMST R, USR U
      WHERE COLDEPTCD IN (SELECT DEPT_ID FROM DEPT
                          CONNECT BY PRIOR DEPT_ID = UPPER_DEPT_ID
                          START WITH DEPT_ID = (SELECT DEPT_ID FROM DEPT WHERE DEPT_DEPTH = 1))
      AND STRDT <= TO_CHAR(SYSDATE,'YYYY-MM-DD')
      AND ENDDT >= TO_CHAR(SYSDATE,'YYYY-MM-DD')
      AND RANGE = '1'
      AND CASE (SELECT COUNT(*) FROM CCD WHERE CCDCD = '016' AND CCDSUBCD = '03' AND UPPER(CCDNAME) = 'N')
          WHEN 1 THEN CASE (SELECT COUNT(*) FROM REQMST WHERE R.REQFORMNO = REQFORMNO AND PRESENTID = U.USER_ID)
          WHEN 0 THEN 1 ELSE 0 END ELSE 1 END = 1
      --AND CASE R.DUPLICHECK WHEN '0' THEN 0
      --    ELSE CASE (SELECT COUNT(*) FROM REQMST WHERE R.REQFORMNO = REQFORMNO AND PRESENTID = U.USER_ID)
      --         WHEN 0 THEN 0 ELSE 1 END END = 0
      GROUP BY U.USER_ID) E,
     (SELECT U.USER_ID, COUNT(*) FCNT
      FROM REQFORMMST R1, REQMST R2, USR U
      WHERE R1.REQFORMNO = R2.REQFORMNO
      AND R1.CHRGUSRID = U.USER_ID
      AND R1.COLDEPTCD = U.DEPT_ID
      AND R1.STRDT <= TO_CHAR(SYSDATE,'YYYY-MM-DD')
      AND (R1.ENDDT >= TO_CHAR(SYSDATE,'YYYY-MM-DD') OR R1.ENDDT IS NULL)
      AND STATE <= '02'
      GROUP BY U.USER_ID) F
WHERE U.USER_ID = A.USER_ID(+)
AND U.USER_ID = B.USER_ID(+)
AND U.USER_ID = C.USER_ID(+)
AND U.USER_ID = D.USER_ID(+)
AND U.USER_ID = E.USER_ID(+)
AND U.USER_ID = F.USER_ID(+)
ORDER BY ACNT + BCNT + CCNT + DCNT + ECNT + FCNT DESC, 
         3 DESC, 4 DESC, 5 DESC, 6 DESC, 7 DESC, 8 DESC;

COMMENT ON TABLE  EJMSCOUNT IS '[취]처리현황';
COMMENT ON COLUMN EJMSCOUNT.USER_ID IS '사용자ID';
COMMENT ON COLUMN EJMSCOUNT.USER_NAME IS '사용자명';
COMMENT ON COLUMN EJMSCOUNT.COLLPROC_COUNT IS '취합문서';
COMMENT ON COLUMN EJMSCOUNT.DELIVERY_COUNT IS '배부대기';
COMMENT ON COLUMN EJMSCOUNT.INPUTING_COUNT IS '입력대기';
COMMENT ON COLUMN EJMSCOUNT.RESEARCH_COUNT IS '설문조사';
COMMENT ON COLUMN EJMSCOUNT.SINCHUNG_COUNT IS '신청서';
COMMENT ON COLUMN EJMSCOUNT.S_PROCWAIT_COUNT IS '처리대기신청서';